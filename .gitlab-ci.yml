stages:
  - test
  - deploy
  - pushToECR

test:
  stage: test
  script:
    - docker run --rm -v $(pwd):/code:ro -w /code --entrypoint=/code/ci/test.sh bluetab/amazonlinux-python3-neo4j:20180424163150279987171
  artifacts:
    untracked: true

deploy:
  stage: deploy
  script:
    - git branch -f master HEAD
    - export NEO4J_PASSWORD=$(echo $NEO4J_PASSWORD | sed -e "s/\//\\\\\//g")
    - export GUARDIAN_SECRET_KEY=$(echo $GUARDIAN_SECRET_KEY | sed -e "s/\//\\\\\//g")
    - export PRODUCTION_HOST=$(echo $PRODUCTION_HOST | sed -e "s/\//\\\\\//g")
    - export PRODUCTION_USER=$(echo $PRODUCTION_USER | sed -e "s/\//\\\\\//g")
    - docker run --rm -e NEO4J_PASSWORD=$NEO4J_PASSWORD -e PRODUCTION_HOST=$PRODUCTION_HOST -e PRODUCTION_USER=$PRODUCTION_USER -e PRODUCTION_PEM="$PRODUCTION_PEM" -e GUARDIAN_SECRET_KEY="$GUARDIAN_SECRET_KEY" -e USER=$USER -e BUILD_AT=$BUILD_AT -e TERM=$TERM -v $(pwd):/code:ro -w /code --entrypoint=/code/ci/deploy.sh bluetab/amazonlinux-python3-neo4j:20180123125610087277324
  only:
    - master

pushToECR:
  stage: pushToECR
  script:
    - git branch -f master HEAD
    - export VERSION=$(cat version)
    - export PROJECT_NAME=${PWD##*/}
    - export AWS_ACCESS_KEY_ID=$(echo $AWS_ACCESS_KEY_ID | sed -e "s/\//\\\\\//g")
    - export AWS_SECRET_ACCESS_KEY=$(echo $AWS_SECRET_ACCESS_KEY | sed -e "s/\//\\\\\//g")
    - export AWS_DEFAULT_REGION=$(echo $AWS_DEFAULT_REGION | sed -e "s/\//\\\\\//g")
    - docker build -t bluetab-truedat/$PROJECT_NAME:latest .
    - docker run --rm -t $(tty &>/dev/null && echo "-i") -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" -e "AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}" mesosphere/aws-cli ecr get-login --no-include-email --region $AWS_DEFAULT_REGION | awk '{ sub("\r$", ""); print }' > output
    - bash -f output
    - export ECR=$(cat output | egrep -o 'https?://[^ ]+' | awk -F/ '{print $3}')
    - docker tag bluetab-truedat/$PROJECT_NAME:latest $ECR/bluetab-truedat/$PROJECT_NAME:latest
    - docker tag bluetab-truedat/$PROJECT_NAME:latest $ECR/bluetab-truedat/$PROJECT_NAME:${VERSION}
    - docker push $ECR/bluetab-truedat/$PROJECT_NAME:latest
    - docker push $ECR/bluetab-truedat/$PROJECT_NAME:${VERSION}
    - rm output
    - sleep 10
    - AUX_PNG=$(docker run --rm -t $(tty &>/dev/null && echo "-i") -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" -e "AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}" mesosphere/aws-cli ecs list-tasks --cluster privateServices --service-name td-dl-service | grep arn:)
    - echo $AUX_PNG
    - AUX_PNG=(${AUX_PNG//// })
    - TASK_PNG=${AUX_PNG[1]}
    - echo $TASK_PNG
    - TASK_PNG=${TASK_PNG#\"}
    - echo $TASK_PNG
    - docker run --rm -t $(tty &>/dev/null && echo "-i") -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" -e "AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}" mesosphere/aws-cli ecs stop-task --cluster privateServices --task $AUX_PNG

  only:
    - master